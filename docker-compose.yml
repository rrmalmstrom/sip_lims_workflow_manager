services:
  sip-lims-workflow:
    # Use pre-built deterministic image for production, local deterministic build for development
    image: ${DOCKER_IMAGE:-ghcr.io/rrmalmstrom/sip_lims_workflow_manager:latest}
    
    # Force ARM64 platform for deterministic behavior across all systems
    # This ensures identical package versions and behavior on Windows/Mac/Linux
    # Windows Docker Desktop will use QEMU emulation for ARM64 compatibility
    platform: linux/arm64
    
    container_name: sip-lims-workflow-manager
    
    ports:
      - "127.0.0.1:8501:8501"
    
    volumes:
      # Project data volume - user's project directory
      - type: bind
        source: ${PROJECT_PATH:-.}
        target: /data
        bind:
          create_host_path: true
      
      # Scripts volume - path set by run scripts (workflow-specific in production, user-chosen in development)
      - type: bind
        source: ${SCRIPTS_PATH}
        target: /workflow-scripts
        bind:
          create_host_path: true
    
    working_dir: /data
    
    environment:
      - APP_ENV=${APP_ENV:-production}
      - PROJECT_NAME=${PROJECT_NAME:-data}
      - WORKFLOW_TYPE=${WORKFLOW_TYPE}
    
    # Health check to ensure container is ready
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits for scientific computing workloads
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    # Restart policy - no automatic restart for development tool
    restart: "no"
    
    # Network configuration
    networks:
      - sip-lims-network

networks:
  sip-lims-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16