# Plan: Refactoring the Pooling Workflow Scripts

This document outlines the plan to refactor the Python scripts for the pooling workflow. The primary goal is to remove the dependency on manual Clarity LIMS file interactions, streamlining the process into a single, automated script.

## 1. Objective

Consolidate the essential functions of `scripts/complete.clarity.pool.prep.sheet.py` and `scripts/finish.pooling.libs.py` into a single new script. This new script will handle all calculations, ID generation, and file creation required before the QC stage.

**Proposed New Script Name:** `run.pooling.preparation.py`

## 2. Key Change: Auto-Generating Pool IDs

The core of this refactor is to replace the manual extraction of Pool IDs from the `PoolCreation_...xlsx` file with an automated generation system.

-   **`Pool_id` (Pool Name):**
    -   **Format:** A 5-character uppercase alphabetic string.
    -   **Logic:** A random 5-letter string is generated for the first pool. Each subsequent pool's ID is generated by "incrementing" the previous ID alphabetically (e.g., `PHWOX` -> `PHWOY` -> `PHWOZ` -> `PHWPA`).

-   **`Pool_LIMS` (Pool Container Barcode):**
    -   **Format:** A string composed of the constant prefix `"27-"` followed by a 6-digit number.
    -   **Logic:** A random 6-digit number is generated for the first pool. Each subsequent pool's LIMS ID is generated by incrementing the number by 1 (e.g., `27-794788` -> `27-794789`).

## 3. New Script Workflow: `run.pooling.preparation.py`

The new script will execute the following steps in sequence:

1.  **Initialization & Setup:**
    -   Import necessary libraries.
    -   Define all required directory paths (`PROJECT_DIR`, `ARCHIV_DIR`, `POOL_DIR`, etc.).

2.  **Read Inputs:**
    -   Read the `lib_info_submitted_to_clarity.db` into a pandas DataFrame.
    -   Read the `assign_pool_number_sheet.xlsx` to get pooling constants and plate-to-pool assignments.

3.  **Core Calculations & Pool Definition:**
    -   **`assignPool()`**: Assign libraries to pools and perform validation (check for index collisions, plate limits).
    -   **`getLibMass()`**: Calculate the target mass for each library.
    -   **`getLibVolumes()`**: Calculate transfer volumes and determine source plates (concentrated vs. diluted).

4.  **Auto-Generate Pool IDs:**
    -   Implement a new function, `autoGeneratePoolIDs()`, with the logic described in Section 2.
    -   Merge the new `Pool_id` and `Pool_LIMS` values back into the main DataFrame.
    -   Update `Destination_Tube_Name` and `Destination_Tube_Barcode` columns accordingly.

5.  **Generate All Downstream Files:**
    -   Execute all the original file-generating functions in order:
        -   `addPippinInfo()`
        -   `makePoolTransferFiles()`
        -   `makeTubeBarcodeFiles()`
        -   `makePippinTransferFiles()`
        -   `makePippinBarcodeFile()`
        -   `makeFAinputFiles()`
    -   Generate the final `pool_summary.csv` file, which is the required input for the next major workflow step.

6.  **Finalize and Archive:**
    -   **Archive Database:** Get a current timestamp, rename the existing `lib_info_submitted_to_clarity.db` with the timestamp, and move it to the `archived_files/` directory.
    -   **Create New Database:** Save the final, enriched DataFrame to a new `lib_info_submitted_to_clarity.db`.
    -   Create a success marker file to indicate successful completion.

## 4. Impact on Downstream Scripts

This plan is designed to have **no impact** on the downstream scripts (`pool.FA12.analysis.py` and `rework.pooling.steps.py`). The format and content of the `pool_summary.csv` and other generated files will be identical to the original workflow, ensuring full compatibility.